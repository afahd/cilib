#!/bin/bash

BUILDID_FILE=${WORKSPACE}/logs/build_id
BUILD_ID=$1
PROJECT=alps
BRANCH=master


## if the build is specified it would be used, and if buildid file exists, that build id would be used,
## otherwise  aurora build would be run
if [[ -n ${BUILD_ID} ]]; then
  echo "${BUILD_ID} provided as paramenter"
elif [[ -e ${BUILDID_FILE} ]]; then
  echo "Build id file exists, path to build id file is ${BUILDID_FILE}"
  IFS="=" read -r id BUILD_ID<${BUILDID_FILE}
else
  tag=$(uuidgen | awk '{print substr($0,0,5)}')
  TAG="atc${tag}"
  echo "No file found with build id or build id specified creating new build with tag $TAG"
  aurora build -p ${PROJECT} -b ${BRANCH} --tag ${TAG}
  bld_retval=$?
  if [[ $bld_retval -ne 0 ]]; then
    echo "aurora build failed"
    exit $bld_retval
  fi
fi

echo "$BUILD_ID"

## Run aurora run utility
echo "Preparing to run aurora run..."
## Creating a script for aurora-run
cat > aurora_run_script <<__HEREDOC
#!/bin/bash

echo "++++++++++++++++"
echo "|this is a test|"
echo "++++++++++++++++"

__HEREDOC

aurora run -l ${BUILD_ID} -s aurora_run_script -W ${WORKSPACE}/logs/aurora_run
run_retval=$?
if [[ "$run_retval" -eq 0 ]]; then
  echo "PASSED"
fi

exit $run_retval
