#!/bin/bash
export PATH=@CMAKE_BINARY_DIR@/:/opt/pg/scripts:/opt/pg/scripts/gcloud/aurora/pipeline_scripts/:$PATH
source pl_help.sh
source pl_settings.conf

echo "gen_user_tests.sh $@"
# read the options
TEMP=`getopt -o b:i:n:r:b:s:d:h --long base_script:,test_iterations:,script:,num_instances:,base_script_dir:,dest_script_dir:,\help -n 'gen_test_script.sh' -- "$@"`
eval set -- "$TEMP"

# extract options and their arguments into variables.
while true ; do
  case "$1" in
    -b|--base_script)
      BASE_SCRIPT=$2 ; shift 2 ;;
    -i|--test_iterations)
      TEST_ITERATIONS=$2 ; shift 2 ;;
    -n|--num_instances)
      NUM_INSTANCES=$2 ; shift 2 ;;
    -r|--base_script_dir)
      BASE_SCRIPT_DIR=$2 ; shift 2;;
    -d|--dest_script_dir)
      DEST_SCRIPT_DIR=$2 ; shift 2 ;;
    -s|--script)
      TEST_SCRIPT=$2 ; shift 2 ;;
    -h|--help)
      #TODO
      show_gen_test_scripts_help
      exit 0 ;;
    --) shift ; break ;;
    *) exit 1 ;;
  esac
done
echo "**** BASE_SCRIPT_DIR=$BASE_SCRIPT_DIR **** "


ScriptName=${BASE_SCRIPT}
DScript="${ScriptName}-1"
#Number of tests
i=-1
#Read the user provided file, ignore blank lines
#Populate test names in string to insert in the script
for word in `sed '/^$/d' ${TEST_SCRIPT}`; do
  TestNames="$TestNames \"$word\""
  ((i++))
done

#echo "cp $ScriptName ${DEST_SCRIPT_DIR}/$DScript"
echo "cp ${BASE_SCRIPT_DIR}/$ScriptName ${DEST_SCRIPT_DIR}/$DScript"
cp ${BASE_SCRIPT_DIR}/$ScriptName ${DEST_SCRIPT_DIR}/$DScript
#Array of test names
sed -i "s/USER_TEST=.*/USER_TEST=(${TestNames})/" ${DEST_SCRIPT_DIR}/$DScript
#Replace test_name to iterate over USER_TEST array
sed -i 's/^\s*test_name=.*/test_name=${USER_TEST[$testno]}/' ${DEST_SCRIPT_DIR}/$DScript
#Export all tests
sed -i 's/PIPELINE=.*/PIPELINE='DEBUG-TEST'/' ${DEST_SCRIPT_DIR}/$DScript
sed -i 's/CTEST_ST=[0-9]*/CTEST_ST=0/' ${DEST_SCRIPT_DIR}/$DScript
sed -i 's/CTEST_ED=[0-9]*/CTEST_ED='$i'/' ${DEST_SCRIPT_DIR}/${DScript}
sed -i 's/total_tests=.*$/total_tests='$((i+1))'/' ${DEST_SCRIPT_DIR}/${DScript}
#Replace iteration
sed -i 's/itr=[0-9]*/itr='${TEST_ITERATIONS}'/' ${DEST_SCRIPT_DIR}/$DScript

for instance_no in `seq 2 $NUM_INSTANCES`
do
  #Think of a better name
  DScript_X="${ScriptName}-$instance_no"
  cp ${DEST_SCRIPT_DIR}/$DScript ${DEST_SCRIPT_DIR}/$DScript_X
  sed -i 's/instance_no=.*/instance_no='${instance_no}'/' ${DEST_SCRIPT_DIR}/$DScript
done
