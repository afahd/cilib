#!/bin/bash
export PATH=@CMAKE_BINARY_DIR@/:/opt/pg/scripts:/opt/pg/scripts/gcloud/aurora/pipeline_scripts/:$PATH
. ~/.aurora.conf
. aurora_utils.sh


# *****************************************************************************
# Function: cleanup
# Purpose : Cleans up the all the run-instances/bld-snapshots/run-disks for a
#			particular build-id.
# Usage   : cleanup <build-id>
# Prereq  :
# *****************************************************************************
function cleanup() {
  start_time=$(date +%s)
  local BUILD_ID=$1
  if [[ -z $BUILD_ID ]]; then
    echo "no build given"
    exit 1
  fi
  local RUN_ID=$(echo "$BUILD_ID" | sed "s/bld/run/g")
  #Delete the build Instance
  delete_instances "${BUILD_ID}" "--force"
  #Delete the run instances
  delete_instances "${RUN_ID}" "--force"
  #Delete the snapshots
  delete_snapshots "${BUILD_ID}-(ssd1|ssd2)" "--force"
  #Delete any remaining disks just to be safe.
  delete_disks "${RUN_ID}-.*(d1|d2)" "--force"
  delete_disks "${BUILD_ID}-(d1|d2)" "--force"
  end_time=$(date +%s)
  print_time_taken $start_time $end_time "cleanup"
}
cleanup $1
