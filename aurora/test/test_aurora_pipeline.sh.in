#!/bin/bash

BUILDID_FILE=${WORKSPACE}/logs/build_id

PIPELINE=$1
BUILD_ID=$2
PROJECT=alps
BRANCH=master

## if the build is specified it would be used, and if buildid file exists, that build id would be used,
## otherwise  aurora build would be run
if [[ -n ${BUILD_ID} ]]; then
  echo "${BUILD_ID} provided as paramenter"
elif [[ -e ${BUILDID_FILE} ]]; then
  echo "Build id file exists, path to build id file is ${BUILDID_FILE}"
  IFS="=" read -r id BUILD_ID<${BUILDID_FILE}
else
  tag=$(uuidgen | awk '{print substr($0,0,5)}')
  TAG="atc${tag}"
  echo "No file found with build id or build id specified creating new build with tag $TAG"
  aurora build -p ${PROJECT} -b ${BRANCH} --tag ${TAG}
  bld_retval=$?
  if [[ $bld_retval -ne 0 ]]; then
    echo "aurora build failed"
    exit $bld_retval
  fi
fi

echo "$BUILD_ID"

## Run the pipeline provided in parameter
echo "$PIPELINE"
aurora pipeline -l $BUILD_ID -P $PIPELINE -W ${WORKSPACE}/logs/aurora_pipeline
pipeline_retval=$?
if [[ "$pipeline_retval" -ne 0 ]]; then
  # Check the number of failures in the failing-list.log file
  num_failures=$(cat ${WORKSPACE}/logs/aurora_pipeline/logs/failing-list.log | wc -l)
  if [[ $num_failures -lt 5 && -f ${WORKSPACE}/logs/aurora_pipeline/logs/failing-list.log ]]; then
    pipeline_retval=0
    echo "PASSED"
  fi
else
  echo "PASSED"
fi

exit $pipeline_retval
