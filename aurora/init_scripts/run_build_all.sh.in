#!/bin/bash
#Restarting the lxc-net service
#TODO: This block might not be needed anymore
echo "Restarting the lxc-net service"
sudo ifconfig lxcbr0 down || true
sudo brctl delbr lxcbr0 || true
sudo pkill dnsmasq || true
sudo service lxc-net restart

. /opt/pg/env/alps.bashrc

project_list=("pg_ui" "sal" "pkg" "pg_cli" "common-config" "balicek" "python-plumgridlib" "corelib" "coral" "alps")
for project in ${project_list[@]}; do
  if [[ ${project} == "coral" ]]; then
    cd ~/work/coral/devtools
    ./coral_build.sh
  else
    cd ~/work/${project}/build
    if [[ ${project} == "alps" ]]; then
      for i in `seq 1 4`; do
          return_value=0
          make -k -j 4 install || return_value=$?
          [[ $return_value -eq 0 ]] && break
      done
    else
      make -j 4 install
    fi
  fi
  if [[ ${project} == "python-plumgridlib" ]]; then
      cd ~/work/python-plumgridlib/lib
      sudo python setup.py install
  fi
done

. /home/plumgrid/apt_component.sh
export JENKINS_BUILDER_SCRIPT_DIR=/home/plumgrid/work/builder
${JENKINS_BUILDER_SCRIPT_DIR}/jenkins-build-pkgs.sh -W "/home/plumgrid/work"