#!/bin/bash
sudo apt-get install parallel
# Adding the net-10-10 nameserver entry in case it's not there
sudo chown plumgrid:plumgrid /etc/resolv.conf
echo "nameserver 10.10.0.1" >> /etc/resolv.conf
#Restarting the lxc-net service
echo "Restarting the lxc-net service"
sudo ifconfig lxcbr0 down || true
sudo brctl delbr lxcbr0 || true
sudo pkill dnsmasq || true
sudo service lxc-net restart

. /opt/pg/env/alps.bashrc

project_list=("pg_ui" "sal" "pkg" "pg_cli" "common-config" "balicek" "python-plumgridlib" "corelib" "coral" "alps")

for project in ${project_list[@]}; do
  if [[ ${project} == "coral" ]]; then
    cd ~/work/coral/devtools
    ./coral_build.sh
  else
    cd ~/work/${project}/build
    if [[ ${project} == "alps" ]]; then
      for i in `seq 1 4`; do
          return_value=0
          make -k -j 4 install || return_value=$?
          [[ $return_value -eq 0 ]] && break
      done
    else
      make -j 4 install
    fi
  fi
  if [[ ${project} == "python-plumgridlib" ]]; then
      cd ~/work/python-plumgridlib/lib
      sudo python setup.py install
  fi
done

. /home/plumgrid/apt_component.sh
export JENKINS_BUILDER_SCRIPT_DIR=/home/plumgrid/work/builder
${JENKINS_BUILDER_SCRIPT_DIR}/jenkins-build-pkgs.sh -W "/home/plumgrid/work"
# This is here only untill https://gerrit:8443/#/c/10751/ gets merged.
sed -i '/restart_lxc lvm/a tryexec lxc-attach -n lvm -- /bin/bash -c \"echo 'NOZEROCONF=true' >> /etc/sysconfig/network\"' /opt/pg/systest/lxc/automaton/automaton-helpers.sh

sudo /home/plumgrid/work/alps/build/scripts/jenkins/lxc-automaton-longevity-jenkins-init.sh
#Stop the lxc
sudo lxc-stop -n lvm -t 10
#Make the lvm lxc auto start
sudo bash -c 'echo "lxc.start.auto = 1" >> /var/lib/lxc/lvm/config'
