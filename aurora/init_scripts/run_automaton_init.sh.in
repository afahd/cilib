#!/bin/bash
set -e
sudo apt-get install parallel
export JCFG_GITHUB_OAUTH='d3936bad97c404516cba043e1da9bdc042b63b25'

# Adding the net-10-10 nameserver entry in case it's not there
sudo chown plumgrid:plumgrid /etc/resolv.conf
echo "nameserver 10.10.0.1" >> /etc/resolv.conf
#Restarting the lxc-net service
echo "Restarting the lxc-net service"
sudo ifconfig lxcbr0 down || true
sudo brctl delbr lxcbr0 || true
sudo pkill dnsmasq || true
sudo service lxc-net restart

source /opt/pg/env/alps.bashrc
cd /home/plumgrid/work/pkg/build
make -j4 install
../scripts/build-all.sh --useallcpus

# This is here only untill https://gerrit:8443/#/c/10751/ gets merged.
sed -i '/restart_lxc lvm/a tryexec lxc-attach -n lvm -- /bin/bash -c \"echo 'NOZEROCONF=true' >> /etc/sysconfig/network\"' /opt/pg/systest/lxc/automaton/automaton-helpers.sh

sudo /home/plumgrid/work/alps/build/scripts/jenkins/lxc-automaton-longevity-jenkins-init.sh
#Stop the lxc
sudo lxc-stop -n lvm -t 10
#Make the lvm lxc auto start
sudo bash -c 'echo "lxc.start.auto = 1" >> /var/lib/lxc/lvm/config'
